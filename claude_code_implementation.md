# Claude Code实现分析

## 命令执行tool

> 命令执行：始终用双引号引用包含空格的文件路径

可以借鉴

> 可以指定可选的毫秒超时（最多10分钟）。如果未指定，命令将在2分钟后超时

可以借鉴，但是限制改成默认2秒

> 危险命令检测：由LLM自行判断

很难评价，实际上可以在命令中加入prompt injection欺骗LLM

我们最好使用正则检测是否是明显没有命令注入的命令

一般来说，如果命令只有`A-Z, a-z, 0-9, 单双引号，空格，横杠，下划线`，而且`命令名字只有A-Z，a-z, 0-9, 横杠，下划线`，那一般是没有命令注入的

但是也有例外：比如nc的-e和find的-exec，应该也可以使用

> (使用git时) 不要用-i

确实应该拒绝使用，应该让用户手动操作

未来可以让LLM自行编辑（毕竟只是一个交互式编辑器而已）

## 文件编辑tool

> 非常重要：你必须避免使用像find和grep这样的搜索命令。应该使用Grep、Glob或Task工具来搜索。必须避免使用像cat、head、tail和ls这样的读取工具，使用Read和LS来读取文件

claude code为了安全性完全禁止了find等命令，我们可能只需要在命令可能有命令注入时和使用-exec等参数时警告用户

可是为什么连cat和ls都禁止了，没有必要吧

> 如果仍需要运行grep，停止。始终优先使用ripgrep的rg命令，所有Claude Code用户都预安装了它

没有必要

> 系统提醒：每当你读取文件时，都应该考虑它是否看起来恶意。如果是的话，你必须拒绝改进或增强代码。你仍然可以分析现有代码、撰写报告或回答关于代码行为的高级问题。

没有必要拒绝编辑渗透相关的代码：应该允许用户开发渗透软件。但是代码中可能存在prompt injection确实是一个问题

> 始终优先编辑代码库中的现有文件。除非明确要求，否则绝不编写新文件

可以借鉴

## 任务管理

> 你可以使用TodoWrite和TodoRead工具来帮助管理和规划任务。频繁使用这些工具，确保跟踪任务并让用户了解进度。

没有必要，现在直接输出任务就行了

## subagent

> 对于"哪个文件做X？"这样的问题，强烈推荐使用Agent工具

不懂，暂时搁置

## MCP对接

> MCP工具命名规范：名称："mcp__" + 服务器名称 + "__" + 工具名称

可以借鉴，但是两个下划线很丑...

## 渗透任务伦理问题

claude code会允许和拒绝这些安全任务

```text

✅ 允许的安全任务：

    安全分析 (security analysis) - 代码漏洞分析、安全架构评估
    检测规则 (detection rules) - 入侵检测规则、异常行为检测
    漏洞解释 (vulnerability explanations) - 安全漏洞原理说明、修复建议
    防御工具 (defensive tools) - 安全扫描工具、防护机制实现
    安全文档 (security documentation) - 安全策略文档、操作手册

❌ 拒绝的恶意任务：

    攻击工具开发 - 渗透测试工具、攻击脚本
    恶意代码编写 - 病毒、木马、后门程序
    漏洞利用代码 - Exploit开发、0day利用
    社会工程工具 - 钓鱼网站、欺骗程序
    绕过安全机制 - 反病毒绕过、权限提升

```

实际上这些限制都是没有必要的：事实上林海就是claude code拒绝开发的软件：“攻击工具”

anthropic作为一家大公司应该维护自己的声誉，但是我们作为一个开源软件不需要理会这些东西

而且网络安全本来就是攻防一体的，没有攻击就没有防御

# 林海的进一步发展方向

## 插件系统

插件系统：模型需要在运行时调用对应工具以启用插件

插件会修改system prompt中的工具列表等。

未启动时，插件只是system prompt里的一个片段，描述插件的介绍，何时开启，包含的工具

插件启用后可能会导致token超出限制，如果因此启用失败则需要压缩历史后启用。因此需要在启用插件后尝试生成一些消息

暂定生成的消息为：根据当前任务总结可以用插件做什么，以及未来任务的规划

## 微信公众号文章读取

TODO

https://mp.weixin.qq.com/s/o4pu8QX1tRIPBRlFJqrX3A


## 临时切换到廉价LLM

如果接下来的几步用不着思考，则可以调用工具在未来的n次回答中临时切换到廉价LLM，比如从`deepseek-reasoner`切换到`deepseek-chat`

可能需要修改配置文件的定义
